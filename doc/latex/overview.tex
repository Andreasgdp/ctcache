\documentclass[compress,table,xcolor=table]{beamer}
\input{beamer_ctcache.tex}
\begin{document}
% ------------------------------------------------------------------------------
\title{Speeding up static analysis with \cmdname{clang-tidy-cache}}
% - Intro ----------------------------------------------------------------------
\section{Introduction}
\frame{\titlepage}
% ------------------------------------------------------------------------------
\begin{frame}
  \Huge
  \centering{Introduction}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
  \frametitle{\cmdname{clang-tidy}}
  \begin{itemize}
      \item{\LARGE{\say{a \cmdname{clang}-based C++ static analysis
          tool\footnote{\url{https://clang.llvm.org/extra/clang-tidy/}}}}}
      \begin{itemize}
      \item{an extensible framework for diagnosing and fixing typical
          programming errors,}
      \item{has a comprehensive suite of built-in checks, for}
        \begin{itemize}
        \item{style violations,}
        \item{language misuse,}
        \item{anti-patterns,}
        \item{common bugs,}
        \item{etc.}
        \end{itemize}
      \item{provides a convenient interface for writing new checks,}
      \item{is configurable, with a large set of options.}
      \end{itemize}
  \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
    \frametitle{Using \cmdname{clang-tidy} with \cmdname{cmake}}
    \LARGE
    \begin{itemize}
    \item \cmdname{cmake} has some built-in support for \cmdname{clang-tidy}:
        \Large
        \begin{itemize}
        \item the \inlinecode{CXX\_CLANG\_TIDY} target property\footnote{
                \url{https://cmake.org/cmake/help/latest/manual/cmake-properties.7.html}}.
        \item the generated build system code includes instructions to run
            \cmdname{clang-tidy}, typically chained with the compilation
                commands.
        \end{itemize}
    \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}[fragile]
  \Large
  Find the \cmdname{clang-tidy} command:
  \begin{lstlisting}[language=cmake]
  find_program(
    CLANG_TIDY_COMMAND
    clang-tidy
  )
  \end{lstlisting}

  Add executable;
  \begin{lstlisting}[language=cmake]
  add_executable(my_target my_target.cpp)
  \end{lstlisting}

  or library target:
  \begin{lstlisting}[language=cmake]
  add_library(my_target my_target.cpp)
  \end{lstlisting}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}[fragile]
  \Large
  If \cmdname{clang-tidy} was found, tell \cmdname{cmake} to check the sources
  as a part of compilation:
  \begin{lstlisting}[language=cmake]
  if(CLANG_TIDY_COMMAND)
    set_target_properties(
      my_target PROPERTIES
      (*@\listinghl{CXX\_CLANG\_TIDY \$\{CLANG\_TIDY\_COMMAND\}}@*)
    )
  endif()
  \end{lstlisting}
\end{frame}
% - Motivation -----------------------------------------------------------------
\section{Motivation}
% ------------------------------------------------------------------------------
\begin{frame}
  \frametitle{The downsides of using \cmdname{clang-tidy}}
    \LARGE
    \begin{itemize}
    \item Running static analysis takes time, {\larger a lot} of time.
        \Large
        \begin{itemize}
        \item Often more time than the actual compilation.
        \item Unacceptable increase in build times.
        \item Switching static analysis on/off:
            \begin{itemize}
            \item Not ideal.
            \item When do we flip the switch?
            \item Typically ends up always off.
            \end{itemize}
        \end{itemize}
    \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}[fragile]
  \frametitle{Switching \cmdname{clang-tidy} checks on/off with \cmdname{cmake}}
  \Large
   Add a \cmdname{cmake} option:
  \begin{lstlisting}[language=cmake]
  option(
    (*@\listinghl{WITH\_STATIC\_ANALYSIS}@*)
    "Enable static analysis" ON
  )
  \end{lstlisting}

  Add analysis-related target properties only when switched on:

  \begin{lstlisting}[language=cmake]
  if((*@\listinghl{WITH\_STATIC\_ANALYSIS}@*) and CLANG_TIDY_COMMAND)
    set_target_properties(
      my_target PROPERTIES
      CXX_CLANG_TIDY ${CLANG_TIDY_COMMAND}
    )
  endif()
  \end{lstlisting}

\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
  \frametitle{The reason for build slowdowns}
    \LARGE
    \begin{itemize}
    \item Typically most of the code that is analysed doesn't change.
        \begin{itemize}
        \Large
        \item It is re-checked with the same result over and over.
        \item Unless you change something in the core sources included
            everywhere.
        \end{itemize}
    \end{itemize}
\end{frame}
% - Solution -------------------------------------------------------------------
\section{Solution}
% ------------------------------------------------------------------------------
\begin{frame}
  \frametitle{The solution -- analysis result caching}
    \Large
    \begin{itemize}
    \item If we can uniquely identify a static-analysis tool invocation
        we can store the result and retrieve it when the same invocation
        is repeated.
        \begin{itemize}
        \item Similar to compilation-caching\footnote{
            \url{https://ccache.dev/}}.
        \item Track all inputs of the analysis:
            \begin{itemize}
            \large
            \item configuration options,
            \item command-line arguments,
            \item the source files,
            \item etc.
            \end{itemize}
        \end{itemize}
    \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}[fragile]
  \frametitle{How is it used?}
  \LARGE
  Create a wrapper script, like:
  \begin{lstlisting}[language=bash]
  #!/bin/bash
  REAL_CT=/full/path/to/clang-tidy

  /path/to/clang-tidy-cache \
    "${REAL_CT}" "${@}"
  \end{lstlisting}
  Put it into a directory in search \inlinecode{PATH}, before real
  \cmdname{clang-tidy}.
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
  \frametitle{How does it work?}
    \LARGE
    \begin{itemize}
        \item Scans the command-line arguments of \cmdname{clang-tidy} and
            its input:
        \begin{itemize}
            \Large
            \item configuration files,
            \item analysed source files.
        \end{itemize}
        \item Makes a hash uniquely identifying the invocation from
            the above.
    \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
  \frametitle{How does it work?}
    \LARGE
    \begin{itemize}
        \item Checks if the hash is in the cache database:
        \begin{itemize}
            \Large
            \item if it is -- don't run \cmdname{clang-tidy} and return
                immediately -- typically {\larger much} faster.
            \item otherwise -- run \cmdname{clang-tidy} and if successful
                store the hash.
        \end{itemize}
    \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
  \frametitle{Modes of operation}
    \Huge
    \begin{itemize}
        \item Local
        \item Client / Server
    \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
    \frametitle{Local mode}
    \LARGE
    \begin{itemize}
        \item Stores the database in a local directory hierarchy.
        \item Location determined by the \inlinecode{CTCACHE\_DIR} environment
            variable.
        \item By default a sub-tree in the temporary directory.
        \item If you want persistence specify a directory in
            a disk-based file system.
    \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
    \frametitle{Client / server mode}
    \LARGE
    \begin{itemize}
        \item \cmdname{clang-tidy-cache-server}
        \begin{itemize}
            \Large
            \item HTTP server exposing a REST API.
            \item Can be used to store and retrieve hashes from the client.
            \item The client (\cmdname{clang-tide-cache}) can query
                the server -- still way faster than running \cmdname{clang-tidy}.
            \item Environment variables:
            \begin{itemize}
                \large
                \item \inlinecode{CTCACHE\_HOST}
                \item \inlinecode{CTCACHE\_PORT}
            \end{itemize}
        \end{itemize}
    \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
  \frametitle{Server pages}
  \LARGE
  \begin{itemize}
  \item The clang tidy-cache's HTTP server also serves several web pages
    that are designed to be viewed in a browser:
    \begin{itemize}
        \item the {\em dashboard} -- the main one,
        \item SVG plots -- server statistics.
    \end{itemize}
  \end{itemize}
\end{frame}
% ------------------------------------------------------------------------------
\begin{frame}
  \frametitle{Server dashboard}
  \fitfig{dashboard}
\end{frame}
% - Deployment -----------------------------------------------------------------
\section{Deployment}
% ------------------------------------------------------------------------------
\end{document}
